<style>
    .loader { border-top-color: #4f46e5; animation: spinner 1.5s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .success-animate { animation: slideUp 0.5s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>

<div id="fees-portal-wrapper" class="p-2 md:p-6 animate-in fade-in duration-500">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
        <div>
            <h2 class="text-2xl font-black text-slate-800">Fee Payment Dashboard</h2>
            <p class="text-slate-500 font-medium">Student ID: <span class="text-indigo-600">IIT-9920-CS</span></p>
        </div>
        <div class="text-left md:text-right">
            <p class="text-xs font-bold text-indigo-600 uppercase tracking-widest">Net Outstanding Balance</p>
            <p class="text-4xl font-black text-slate-900" id="total-balance-display">₹75,500</p>
            <p class="text-[10px] text-red-500 font-bold">*Includes ₹500 Late Fine</p>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                <div class="p-8 border-b bg-indigo-50/30">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">Configure Payment</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Degree / Course</label>
                            <select class="w-full border-2 border-slate-100 p-2 rounded-xl bg-white font-medium text-sm">
                                <option>B.Tech Computer Science</option>
                                <option>B.Tech Electrical Engineering</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Semester</label>
                            <select class="w-full border-2 border-slate-100 p-2 rounded-xl bg-white font-medium text-sm">
                                <option>Semester IV (Current)</option>
                                <option>Semester III (Backlog Fees)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="p-8">
                    <div class="mb-8 p-6 bg-slate-900 rounded-2xl text-white">
                        <label class="block text-xs font-bold text-indigo-300 uppercase mb-2 tracking-widest">Amount to Pay (INR)</label>
                        <div class="flex items-center gap-4">
                            <span class="text-3xl font-bold text-indigo-400">₹</span>
                            <input type="number" id="pay-amount-input" value="75500" class="bg-transparent text-4xl font-black focus:outline-none w-full" oninput="updateGatewayLabels(this.value)">
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 italic">*Partial payments accepted (Min ₹1,000)</p>
                    </div>

                    <button onclick="showGateway()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-5 rounded-2xl font-bold text-lg shadow-lg shadow-indigo-100 transition-all flex items-center justify-center gap-3 active:scale-95">
                        Proceed to Payment <i class="fas fa-arrow-right text-sm"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-6 border-b bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 tracking-tight">Payment History</h3>
                    <i class="fas fa-history text-slate-400"></i>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse" id="history-table">
                        <thead class="bg-slate-50 text-[10px] uppercase font-bold text-slate-400 tracking-widest">
                            <tr>
                                <th class="p-4 border-b">Date</th>
                                <th class="p-4 border-b">Ref ID</th>
                                <th class="p-4 border-b">Amount</th>
                                <th class="p-4 border-b">Status</th>
                            </tr>
                        </thead>
                        <tbody id="history-body" class="text-xs divide-y divide-slate-100">
                            <tr>
                                <td class="p-4">12 Oct 2024</td>
                                <td class="p-4 text-slate-400">#TXN-4421</td>
                                <td class="p-4 font-bold text-slate-700">₹5,000.00</td>
                                <td class="p-4"><span class="px-2 py-1 bg-green-100 text-green-600 rounded-md font-bold">SUCCESS</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="bg-indigo-900 text-white rounded-3xl p-8 sticky top-6 shadow-2xl overflow-hidden">
                <div class="relative z-10">
                    <h4 class="font-bold opacity-50 uppercase text-xs tracking-widest mb-6">Settlement Summary</h4>
                    <div class="space-y-4 pb-6 border-b border-white/10">
                        <div class="flex justify-between text-sm"><span>Tuition</span><span>₹60,000</span></div>
                        <div class="flex justify-between text-sm"><span>Hostel</span><span>₹12,000</span></div>
                        <div class="flex justify-between text-sm"><span>Library</span><span>₹3,000</span></div>
                        <div class="flex justify-between text-sm text-red-400 font-bold"><span>Late Fine</span><span>₹500</span></div>
                    </div>
                    <div class="pt-6">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-indigo-200">Total Due</span>
                            <span class="text-3xl font-black text-white">₹75,500</span>
                        </div>
                    </div>
                </div>
                <i class="fas fa-university absolute -bottom-10 -right-10 text-9xl text-white/5"></i>
            </div>
        </div>
    </div>
</div>

<div id="payment-gateway-overlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col md:flex-row success-animate">
        <div class="md:w-1/2 p-8 border-r border-slate-100">
            <button onclick="hideGateway()" class="mb-8 text-slate-400 hover:text-indigo-600 font-bold transition-all"><i class="fas fa-times mr-2"></i> Cancel</button>
            <h3 class="text-xl font-black mb-6">Select Method</h3>
            <div class="space-y-3">
                <div onclick="switchFeeTab('upi')" id="btn-upi" class="cursor-pointer flex items-center gap-4 p-4 border-2 border-indigo-600 rounded-2xl bg-indigo-50/50">
                    <i class="fas fa-mobile-alt text-indigo-600"></i><span class="font-bold text-sm">UPI</span>
                </div>
                <div onclick="switchFeeTab('card')" id="btn-card" class="cursor-pointer flex items-center gap-4 p-4 border-2 border-slate-100 rounded-2xl">
                    <i class="fas fa-credit-card text-slate-400"></i><span class="font-bold text-sm text-slate-600">Card</span>
                </div>
            </div>
        </div>
        <div class="md:w-1/2 p-8 bg-slate-50/50">
            <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Paying Amount</p>
            <p id="gateway-total-label" class="text-3xl font-black text-slate-900 mb-8">₹75,500</p>
            
            <div id="tab-upi" class="tab-content active"><input type="text" placeholder="username@upi" class="w-full p-4 border-2 border-slate-200 rounded-2xl mb-4"></div>
            <div id="tab-card" class="tab-content space-y-4"><input type="text" placeholder="Card Number" class="w-full p-4 border-2 border-slate-200 rounded-2xl"></div>

            <div class="flex items-start gap-2 mb-6">
                <input type="checkbox" id="fee-terms" class="mt-1"><label class="text-[10px] text-slate-400">I agree to authorize this transaction.</label>
            </div>
            <button onclick="verifyPayment()" class="w-full bg-indigo-900 text-white py-4 rounded-2xl font-black shadow-xl">SECURE PAY</button>
        </div>
    </div>
</div>

<div id="fee-processing" class="hidden fixed inset-0 bg-white/90 backdrop-blur-sm z-[110] flex flex-col items-center justify-center">
    <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-20 w-20 mb-6"></div>
    <h2 class="text-2xl font-black text-slate-800">Verifying with Bank...</h2>
</div>

<div id="fee-success" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-xl z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-[3rem] p-12 max-w-md w-full text-center success-animate shadow-2xl">
        <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 text-4xl"><i class="fas fa-check"></i></div>
        <h2 class="text-3xl font-black text-slate-800 mb-2">Paid Successfully</h2>
        <p class="text-slate-500 font-medium mb-8">Ref ID: <span id="success-ref" class="font-bold">#TXN-XXXX</span></p>
        <button onclick="closeFeeWorkflow()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold">Return to Portal</button>
    </div>
</div>

<script>
    let currentFeeBalance = 75500;
    let currentPayAmount = 75500;
    let activeMethod = 'upi';

    function updateGatewayLabels(val) {
        currentPayAmount = parseInt(val) || 0;
        document.getElementById('gateway-total-label').innerText = '₹' + currentPayAmount.toLocaleString();
    }

    function showGateway() {
        if(currentPayAmount < 1000) { alert("Min payment is ₹1,000"); return; }
        if(currentPayAmount > currentFeeBalance) { alert("Amount exceeds balance!"); return; }
        document.getElementById('payment-gateway-overlay').classList.remove('hidden');
    }

    function hideGateway() { document.getElementById('payment-gateway-overlay').classList.add('hidden'); }

    function switchFeeTab(type) {
        activeMethod = type;
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + type).classList.add('active');
        document.getElementById('btn-upi').className = (type === 'upi') ? 'cursor-pointer flex items-center gap-4 p-4 border-2 border-indigo-600 rounded-2xl bg-indigo-50/50' : 'cursor-pointer flex items-center gap-4 p-4 border-2 border-slate-100 rounded-2xl';
        document.getElementById('btn-card').className = (type === 'card') ? 'cursor-pointer flex items-center gap-4 p-4 border-2 border-indigo-600 rounded-2xl bg-indigo-50/50' : 'cursor-pointer flex items-center gap-4 p-4 border-2 border-slate-100 rounded-2xl';
    }

    function verifyPayment() {
        if(!document.getElementById('fee-terms').checked) { alert("Please agree to terms."); return; }
        document.getElementById('fee-processing').classList.remove('hidden');
        
        setTimeout(() => {
            const refId = '#TXN-' + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('success-ref').innerText = refId;
            document.getElementById('fee-processing').classList.add('hidden');
            document.getElementById('fee-success').classList.remove('hidden');
            
            // Log to history immediately
            addTransactionToDashboard(currentPayAmount, refId);
            
            // Update Dashboard Balance
            currentFeeBalance -= currentPayAmount;
            document.getElementById('total-balance-display').innerText = '₹' + currentFeeBalance.toLocaleString();
        }, 2000);
    }

    function addTransactionToDashboard(amt, ref) {
        const tbody = document.getElementById('history-body');
        const row = document.createElement('tr');
        row.className = "bg-green-50 success-animate";
        const date = new Date().toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric'});
        row.innerHTML = `
            <td class="p-4 font-medium">${date}</td>
            <td class="p-4 text-slate-400">${ref}</td>
            <td class="p-4 font-bold text-indigo-600">₹${amt.toLocaleString()}.00</td>
            <td class="p-4"><span class="px-2 py-1 bg-green-100 text-green-600 rounded-md font-bold">SUCCESS</span></td>
        `;
        tbody.prepend(row);
    }

    function closeFeeWorkflow() {
        document.getElementById('fee-success').classList.add('hidden');
        document.getElementById('payment-gateway-overlay').classList.add('hidden');
    }
</script>