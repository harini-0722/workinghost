<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Management - Hostel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/heroicons@2.1.1/dist/solid/index.js"></script>
    <script type="module" src="https://unpkg.com/heroicons@2.1.1/dist/outline/index.js"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #1f2937;
        }
        /* Visual adjustments for card/form elements */
        .staff-avatar { object-fit: cover; }
        .form-label { font-size: 0.75rem; font-weight: 600; color: #4b5563; /* Gray-700 */ }
        .form-input { border-radius: 0.5rem; border-color: #d1d5db; font-size: 0.875rem; }
        .card-detail { font-size: 0.8125rem; /* ~13px */ }
        
        /* Modal Styles */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: all 0.3s ease-in-out; transform: translateY(-20px); opacity: 0; }
        .modal.active .modal-backdrop { opacity: 1; }
        .modal.active .modal-content { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col">

    <nav class="bg-white shadow-sm sticky top-0 z-20">
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex-shrink-0 flex items-center">
                    <a href="index.html" target="_top" class="flex items-center text-gray-500 hover:text-blue-600 transition-colors duration-200">
                        <hero-icon-solid name="arrow-left" class="h-5 w-5 mr-2"></hero-icon-solid>
                        Back to Dashboard
                    </a>
                </div>
                <h1 class="text-2xl font-bold text-indigo-600 hidden sm:block">Staff Management System</h1>
                <div class="flex items-center">
                    <span class="text-sm font-medium text-gray-700 mr-3">Admin</span>
                    <div class="flex-shrink-0">
                        <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-yellow-400">
                            <span class="font-medium text-white">A</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full flex-grow">
        <h2 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
            <hero-icon-solid name="user-group" class="h-8 w-8 text-indigo-600 mr-3"></hero-icon-solid>
            Staff Management
        </h2>
        
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="lg:w-1/3 w-full sticky top-20 bg-white p-6 rounded-xl shadow-lg h-fit">
                <h3 class="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">
                    <hero-icon-solid name="user-plus" class="h-5 w-5 mr-2 inline-block"></hero-icon-solid>
                    New Staff Registration
                </h3>
                
                <form id="add-staff-form" class="space-y-4">
                    
                    <div class="space-y-2 border-b pb-3">
                        <p class="text-sm font-semibold text-gray-500">Login & Basic Info</p>
                        <div>
                            <label for="staff-name" class="form-label">Full Name *</label>
                            <input type="text" id="staff-name" name="name" class="mt-1 block w-full form-input shadow-sm" required>
                        </div>
                        <div>
                            <label for="staff-username" class="form-label">Username *</label>
                            <input type="text" id="staff-username" name="username" class="mt-1 block w-full form-input shadow-sm" required>
                        </div>
                        <div>
                            <label for="staff-password" class="form-label">Password *</label>
                            <input type="password" id="staff-password" name="password" class="mt-1 block w-full form-input shadow-sm" required>
                        </div>
                    </div>

                    <div class="space-y-3 border-b pb-3">
                        <p class="text-sm font-semibold text-gray-500">Role & Assignment</p>

                        <div id="staff-role-wrapper">
                            <label for="staff-role-select" class="form-label">Position / Role *</label>
                            <select id="staff-role-select" class="mt-1 block w-full form-input" required>
                                <option value="" disabled selected>-- Select Standard Role --</option>
                                <option value="Warden">Warden</option>
                                <option value="Security">Security</option>
                                <option value="Cleaning Staff">Cleaning Staff</option>
                                <option value="Maintenance Staff">Maintenance Staff</option>
                                <option value="Office Staff">Office Staff</option>
                                <option value="Other">Other (Manual Entry)</option>
                            </select>
                            </div>

                        <div id="staff-place-wrapper">
                            <label for="staff-place-select" class="form-label">Duty Area / Place *</label>
                            <select id="staff-place-select" class="mt-1 block w-full form-input" required>
                                <option value="" disabled selected>-- Loading Blocks --</option>
                            </select>
                            </div>
                    </div>

                    <div class="space-y-2">
                        <p class="text-sm font-semibold text-gray-500">Contact & Photo</p>
                        <div>
                            <label for="staff-phone" class="form-label">Contact Number</label>
                            <input type="tel" id="staff-phone" name="phone" class="mt-1 block w-full form-input shadow-sm" placeholder="+91 XXXXX XXXXX">
                        </div>
                        <div>
                            <label for="staff-email" class="form-label">Email Address</label>
                            <input type="email" id="staff-email" name="email" class="mt-1 block w-full form-input shadow-sm" placeholder="staff@hostel.edu">
                        </div>
                        <div>
                            <label for="staff-profile-image" class="form-label">Profile Photo</label>
                            <input type="file" id="staff-profile-image" name="profileImage" class="mt-1 block w-full text-xs text-gray-500
                                         file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0
                                         file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700
                                         hover:file:bg-indigo-100" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button type="submit" id="add-staff-submit-btn" class="px-5 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                            Save Staff
                        </button>
                    </div>
                </form>
            </div>

            <div class="lg:w-2/3 w-full">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Current Staff Roster</h3>
                <div id="staff-roster-container" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="col-span-full text-center text-gray-500 py-6" id="loading-message">
                        ğŸ”„ Loading staff data...
                    </div>
                </div>
                <p id="no-staff-message" class="text-center text-gray-500 mt-10 hidden">No staff members have been added yet.</p>
            </div>
        </div>
    </main>

    <footer class="mt-12 py-6 border-t border-gray-200 bg-white">
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm text-gray-500">
                &copy; 2025 Staff Management Module. All rights reserved.
            </p>
        </div>
    </footer>

    <div id="staff-details-modal" class="modal hidden fixed inset-0 z-30 flex items-center justify-center">
        <div class="modal-backdrop fixed inset-0" data-modal-hide="staff-details-modal"></div>
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl z-40 w-full max-w-lg mx-4">
            <div id="staff-details-content">
                </div>
            <div class="flex justify-end pt-6 border-t mt-6">
                <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300" data-modal-hide="staff-details-modal">Close</button>
            </div>
        </div>
    </div>
    
  <script>
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  // --- GLOBAL STATE ---
Â  Â  Â  Â  let staffRoster = [];
Â  Â  Â  Â  let availableBlocks = [];

Â  Â  Â  Â  // --- DOM ELEMENTS ---
Â  Â  Â  Â  const staffRosterContainer = document.getElementById('staff-roster-container');
Â  Â  Â  Â  const noStaffMessage = document.getElementById('no-staff-message');
Â  Â  Â  Â  const addStaffForm = document.getElementById('add-staff-form');
Â  Â  Â  Â  const staffRoleWrapper = document.getElementById('staff-role-wrapper');
Â  Â  Â  Â  const staffPlaceWrapper = document.getElementById('staff-place-wrapper');
Â  Â  Â  Â  const staffImageInput = document.getElementById('staff-profile-image');
Â  Â  Â  Â  const submitBtn = document.getElementById('add-staff-submit-btn');
Â  Â  Â  Â  
Â  Â  Â  Â  // --- CORE ROLE OPTIONS ---
Â  Â  Â  Â  const CORE_ROLES = [
Â  Â  Â  Â  Â  Â  "Warden", "Security", "Cleaning Staff", "Maintenance Staff", "Office Staff"
Â  Â  Â  Â  ];
Â  Â  Â  Â  
Â  Â  Â  Â  // --- UTILITY FUNCTIONS ---
Â  Â  Â  Â  function showSuccess(message) { console.log('âœ… ' + message); alert('âœ… ' + message); }
Â  Â  Â  Â  function showError(message) { console.error('âŒ ' + message); alert('âŒ ' + message); }
Â  Â  Â  Â  
Â  Â  Â  Â  function getImageUrl(staff) {
Â  Â  Â  Â  Â  Â  return staff.profileImageUrl || staff.imageDataURL || 'https://via.placeholder.com/150/A5B4FC/374151?text=Staff'; 
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function getRoleColor(role) {
Â  Â  Â  Â  Â  Â  const map = {
Â  Â  Â  Â  Â  Â  Â  Â  'Warden': 'bg-red-600',
Â  Â  Â  Â  Â  Â  Â  Â  'Security': 'bg-yellow-600',
Â  Â  Â  Â  Â  Â  Â  Â  'Cleaning Staff': 'bg-green-600',
Â  Â  Â  Â  Â  Â  Â  Â  'Maintenance Staff': 'bg-blue-600',
Â  Â  Â  Â  Â  Â  Â  Â  'Office Staff': 'bg-purple-600',
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  return map[role] || 'bg-gray-600';
Â  Â  Â  Â  }

Â  Â  Â  Â  function getStatusColor(status) {
Â  Â  Â  Â  Â  Â  return status === 'Active' ? 'text-green-600 bg-green-100' : 'text-yellow-600 bg-yellow-100';
Â  Â  Â  Â  }

Â  Â  Â  Â  function findStaffById(staffId) {
Â  Â  Â  Â  Â  Â  return staffRoster.find(s => (s._id || s.id) == staffId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleNoStaffMessage() {
Â  Â  Â  Â  Â  Â  const isLoading = staffRosterContainer.querySelector('#loading-message');
Â  Â  Â  Â  Â  Â  if (!isLoading && staffRoster.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  noStaffMessage.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  noStaffMessage.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- API CALLS ---
Â  Â  Â  Â  async function loadAvailableBlocks() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch('/api/blocks');
Â  Â  Â  Â  Â  Â  Â  Â  if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  availableBlocks = data.blocks;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Error loading blocks:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadStaffRoster() {
Â  Â  Â  Â  Â  Â  staffRosterContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4" id="loading-message">ğŸ”„ Loading staff data...</div>';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch('/api/staff');
Â  Â  Â  Â  Â  Â  Â  Â  if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const loadingMsg = document.getElementById('loading-message');
Â  Â  Â  Â  Â  Â  Â  Â  if (loadingMsg) loadingMsg.remove();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staffRoster = data.staff;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderStaffRoster();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(data.message || 'Failed to load staff roster.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  const loadingMsg = document.getElementById('loading-message');
Â  Â  Â  Â  Â  Â  Â  Â  if (loadingMsg) loadingMsg.remove();
Â  Â  Â  Â  Â  Â  Â  Â  staffRosterContainer.innerHTML = '<div class="col-span-full text-center text-red-500 py-4">âŒ Failed to load staff roster. Check backend connection.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  toggleNoStaffMessage();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // âœ… MODIFIED: Function to handle FormData submission
Â  Â  Â  Â  async function addStaffMember(formData) {
Â  Â  Â  Â  Â  Â  submitBtn.disabled = true;
Â  Â  Â  Â  Â  Â  submitBtn.textContent = 'Saving...';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // IMPORTANT: When sending FormData, DO NOT set Content-Type header
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch('/api/staff', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: formData // Send FormData directly
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // --- Improved Error Handling for 413, 500, etc. ---
Â  Â  Â  Â  Â  Â  Â  Â  let data;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (jsonError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorText = await res.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check if server returned an HTML error page (starts with <)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (errorText.startsWith('<!DOCTYPE')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`Server request failed with status ${res.status}. (Possible file size limit exceeded: 413)`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Failed to parse server response. Status: ${res.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- End Error Handling ---
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.textContent = 'Save Staff';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSuccess(`Staff member ${data.staff.name || 'added'} added successfully!`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addStaffForm.reset();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staffImageInput.value = ''; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initRoleField(); // Re-initialize fields
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initPlaceField();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadStaffRoster();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Check for the specific "Missing required fields" message here
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(data.message || 'Server failed to add staff.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.textContent = 'Save Staff';
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Error adding staff:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showError('Failed to add staff member: ' + error.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function deleteStaffMember(staffId, staffName) {
Â  Â  Â  Â  Â  Â  if (!confirm(`Are you sure you want to remove ${staffName} from the staff roster? This cannot be undone.`)) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`/api/staff/${staffId}`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSuccess(`ğŸ—‘ï¸ ${staffName} removed successfully.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadStaffRoster(); 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(data.message || 'Server failed to delete staff.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Error deleting staff:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showError('Failed to remove staff member: ' + error.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- DYNAMIC FORM LOGIC FIXES (Minor adjustments) ---

Â  Â  Â  Â  // 1. Position/Role Logic
Â  Â  Â  Â  function initRoleField() {
Â  Â  Â  Â  Â  Â  staffRoleWrapper.innerHTML = '';
Â  Â  Â  Â  Â  Â  const selectId = 'staff-role-select';

Â  Â  Â  Â  Â  Â  let selectHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <label for="${selectId}" class="form-label">Position / Role *</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="${selectId}" class="mt-1 block w-full form-input" required name="role_dropdown_value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>-- Select Standard Role --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${CORE_ROLES.map(role => `<option value="${role}">${role}</option>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other (Manual Entry)</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  staffRoleWrapper.innerHTML = selectHTML;
Â  Â  Â  Â  Â  Â  document.getElementById(selectId).addEventListener('change', handleRoleChange);
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleRoleChange(e) {
Â  Â  Â  Â  Â  Â  const selectElement = e.target;
Â  Â  Â  Â  Â  Â  const selectedValue = selectElement.value;
Â  Â  Â  Â  Â  Â  let manualInput = staffRoleWrapper.querySelector('#staff-role-manual');

Â  Â  Â  Â  Â  Â  if (selectedValue === 'Other') {
Â  Â  Â  Â  Â  Â  Â  Â  if (!manualInput) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.type = 'text';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.id = 'staff-role-manual';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.name = 'role'; // This is the field we submit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.className = 'mt-1 block w-full form-input shadow-sm border-2 border-indigo-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.placeholder = 'Type custom role here (e.g., Senior Electrician)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.required = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hiddenType = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiddenType.type = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiddenType.name = 'role_type';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiddenType.value = 'manual';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectElement.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staffRoleWrapper.appendChild(manualInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staffRoleWrapper.appendChild(hiddenType);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (manualInput) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hiddenField = staffRoleWrapper.querySelector('input[name="role_type"]');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (hiddenField) hiddenField.remove();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  selectElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Duty Area/Place Logic
Â  Â  Â  Â  function initPlaceField() {
Â  Â  Â  Â  Â  Â  staffPlaceWrapper.innerHTML = '';
Â  Â  Â  Â  Â  Â  const selectId = 'staff-place-select';

Â  Â  Â  Â  Â  Â  const blockOptions = availableBlocks.map(block => 
Â  Â  Â  Â  Â  Â  Â  Â  `<option value="${block.blockName}">${block.blockName}</option>`
Â  Â  Â  Â  Â  Â  ).join('');

Â  Â  Â  Â  Â  Â  let selectHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <label for="${selectId}" class="form-label">Duty Area / Place *</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="${selectId}" class="mt-1 block w-full form-input" required name="place_dropdown_value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>-- Select Block or Area --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${blockOptions}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Other">Other (Manual Entry)</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  staffPlaceWrapper.innerHTML = selectHTML;
Â  Â  Â  Â  Â  Â  document.getElementById(selectId).addEventListener('change', handlePlaceChange);
Â  Â  Â  Â  }

Â  Â  Â  Â  function handlePlaceChange(e) {
Â  Â  Â  Â  Â  Â  const selectElement = e.target;
Â  Â  Â  Â  Â  Â  const selectedValue = selectElement.value;
Â  Â  Â  Â  Â  Â  let manualInput = staffPlaceWrapper.querySelector('#staff-place-manual');

Â  Â  Â  Â  Â  Â  if (selectedValue === 'Other') {
Â  Â  Â  Â  Â  Â  Â  Â  if (!manualInput) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.type = 'text';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.id = 'staff-place-manual';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.name = 'place'; // This is the field we submit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.className = 'mt-1 block w-full form-input shadow-sm border-2 border-indigo-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.placeholder = 'Type custom place here (e.g., Canteen, Main Gate)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.required = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hiddenType = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiddenType.type = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiddenType.name = 'place_type';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hiddenType.value = 'manual';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectElement.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staffPlaceWrapper.appendChild(manualInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staffPlaceWrapper.appendChild(hiddenType);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (manualInput) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualInput.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hiddenField = staffPlaceWrapper.querySelector('input[name="place_type"]');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (hiddenField) hiddenField.remove();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  selectElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CARD RENDERING (Unchanged) ---
Â  Â  Â  Â  function renderStaffRoster() {
Â  Â  Â  Â  Â  Â  staffRosterContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  if (staffRoster.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  toggleNoStaffMessage();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  staffRoster.forEach(staff => {
Â  Â  Â  Â  Â  Â  Â  Â  const staffId = staff._id || staff.id;
Â  Â  Â  Â  Â  Â  Â  Â  const roleColorClass = getRoleColor(staff.role);
Â  Â  Â  Â  Â  Â  Â  Â  const statusColorClass = getStatusColor(staff.status || 'Active');

Â  Â  Â  Â  Â  Â  Â  Â  const cardHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-lg border-t-8 border-indigo-600 transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="remove-staff-btn absolute top-3 right-3 p-1 text-red-500 hover:bg-red-100 rounded-full transition-colors duration-200 z-10" data-staff-id="${staffId}" data-staff-name="${staff.name}" title="Remove Staff">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hero-icon-solid name="x-circle" class="h-6 w-6"></hero-icon-solid>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 flex items-center border-b pb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${getImageUrl(staff)}" alt="${staff.name}" class="staff-avatar h-14 w-14 rounded-full mr-4 ring-2 ring-indigo-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-gray-900">${staff.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-white px-2 py-0.5 rounded-full mt-1 inline-block ${roleColorClass}">${staff.role}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 space-y-2 card-detail">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="flex items-start text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hero-icon-solid name="map-pin" class="h-4 w-4 mr-2 text-indigo-500 flex-shrink-0"></hero-icon-solid>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-900">Duty Area:</span> ${staff.place}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="flex items-start text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hero-icon-solid name="envelope" class="h-4 w-4 mr-2 text-indigo-500 flex-shrink-0"></hero-icon-solid>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-900">Email:</span> ${staff.email || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="flex items-start text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hero-icon-solid name="phone" class="h-4 w-4 mr-2 text-indigo-500 flex-shrink-0"></hero-icon-solid>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-900">Phone:</span> ${staff.phone || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="flex items-start text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hero-icon-solid name="check-circle" class="h-4 w-4 mr-2 flex-shrink-0 ${getStatusColor(staff.status || 'Active').split(' ')[0]}"></hero-icon-solid>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-900">Status:</span> 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-semibold px-2 py-0.5 rounded-full text-xs ml-1 ${getStatusColor(staff.status || 'Active')}">${staff.status || 'Active'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 border-t text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="view-staff-details-btn text-indigo-600 hover:text-indigo-800 text-sm font-medium" data-staff-id="${staffId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  View Login Info & Notes &rarr;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  staffRosterContainer.innerHTML += cardHTML;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  toggleNoStaffMessage();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function showStaffDetails(staff) {
Â  Â  Â  Â  Â  Â  const staffDetailsContent = document.getElementById('staff-details-content');
Â  Â  Â  Â  Â  Â  staffDetailsContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-indigo-700 border-b pb-2">Details for ${staff.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 p-4 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-semibold text-gray-800 mb-2 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hero-icon-solid name="key" class="h-5 w-5 mr-2 text-indigo-500"></hero-icon-solid>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Login Credentials
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700"><strong class="font-medium">Username:</strong> ${staff.username || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700"><strong class="font-medium">Password:</strong> [Hidden by design]</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700 pt-2"><strong class="font-medium">Duty Notes:</strong> No notes recorded.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  showModal('staff-details-modal');
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- FORM SUBMISSION LOGIC (Finalized Fix) ---
Â  Â  Â  Â  addStaffForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const rawData = new FormData(addStaffForm); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- 1. Resolve Role and Place Values ---
            // If manual input is present (meaning "Other" was selected), use the manual input field's value ('role'/'place').
            // Otherwise, use the dropdown value ('role_dropdown_value'/'place_dropdown_value').
Â  Â  Â  Â  Â  Â  const assignedRole = rawData.get('role') || rawData.get('role_dropdown_value');
Â  Â  Â  Â  Â  Â  const assignedPlace = rawData.get('place') || rawData.get('place_dropdown_value');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // âœ… Explicit Client-side validation check
Â  Â  Â  Â  Â  Â  if (!rawData.get('name') || !rawData.get('username') || !rawData.get('password') || !assignedRole || assignedRole === 'Other' || !assignedPlace || assignedPlace === 'Other') {
Â  Â  Â  Â  Â  Â  Â  Â  showError('Error: Name, Username, Password, Position/Role, and Duty Area are all required. Please ensure you select a specific role/area or fill out the manual "Other" field.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
            // If the resolved values are still 'Other', it means the user selected the option but didn't fill the manual text box.
            // This is already checked above, but let's be safe.
            if (assignedRole === 'Other' || assignedPlace === 'Other') {
                 showError('Error: You selected "Other" but did not provide a manual entry.');
                 return;
            }

Â  Â  Â  Â  Â  Â  // 1. Create a NEW FormData object for the server
Â  Â  Â  Â  Â  Â  const formDataToSubmit = new FormData();

Â  Â  Â  Â  Â  Â  // 2. Append all fields, ensuring mandatory ones are included
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('name', rawData.get('name'));
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('username', rawData.get('username'));
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('password', rawData.get('password'));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // âœ… FIX: Add joiningDate to satisfy backend validation
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('joiningDate', new Date().toISOString()); 

Â  Â  Â  Â  Â  Â  formDataToSubmit.append('phone', rawData.get('phone') || ''); 
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('email', rawData.get('email') || '');
Â  Â  Â  Â  Â  Â  
            // Append the resolved, guaranteed-valid role and place values
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('role', assignedRole); 
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('place', assignedPlace); 
Â  Â  Â  Â  Â  Â  
            // Append the remaining default/optional fields
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('notes', ''); 
Â  Â  Â  Â  Â  Â  formDataToSubmit.append('status', 'Active'); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 3. Append the file. Multer uses the fieldname 'profileImage'.
Â  Â  Â  Â  Â  Â  const imageFile = staffImageInput.files[0];
Â  Â  Â  Â  Â  Â  if (imageFile) {
Â  Â  Â  Â  Â  Â  Â  Â  formDataToSubmit.append('profileImage', imageFile);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 4. Submit the clean FormData object
Â  Â  Â  Â  Â  Â  addStaffMember(formDataToSubmit);
Â  Â  Â  Â  });

Â  Â  Â  Â  // Listeners for action buttons on the cards
Â  Â  Â  Â  staffRosterContainer.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const removeBtn = e.target.closest('.remove-staff-btn');
Â  Â  Â  Â  Â  Â  const viewBtn = e.target.closest('.view-staff-details-btn');

Â  Â  Â  Â  Â  Â  if (removeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  const staffId = removeBtn.dataset.staffId;
Â  Â  Â  Â  Â  Â  Â  Â  const staffName = removeBtn.dataset.staffName;
Â  Â  Â  Â  Â  Â  Â  Â  deleteStaffMember(staffId, staffName);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (viewBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  const staffId = viewBtn.dataset.staffId;
Â  Â  Â  Â  Â  Â  Â  Â  const staff = findStaffById(staffId);
Â  Â  Â  Â  Â  Â  Â  Â  if (staff) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showStaffDetails(staff);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- GENERIC MODAL LOGIC (Unchanged) ---
Â  Â  Â  Â  function showModal(modalId) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById(modalId);
Â  Â  Â  Â  Â  Â  if (!modal) return;
Â  Â  Â  Â  Â  Â  modal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  void modal.offsetWidth; 
Â  Â  Â  Â  Â  Â  requestAnimationFrame(() => {
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.add('active');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideModal(modalId) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById(modalId);
Â  Â  Â  Â  Â  Â  if (!modal) return;
Â  Â  Â  Â  Â  Â  modal.classList.remove('active');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }, 300); 
Â  Â  Â  Â  }

Â  Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  if (e.target.dataset.modalHide) {
Â  Â  Â  Â  Â  Â  Â  Â  hideModal(e.target.dataset.modalHide);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  async function initApp() {
Â  Â  Â  Â  Â  Â  await loadAvailableBlocks();
Â  Â  Â  Â  Â  Â  await loadStaffRoster();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Initialize dynamic form fields and listeners
Â  Â  Â  Â  Â  Â  initRoleField();
Â  Â  Â  Â  Â  Â  initPlaceField();
Â  Â  Â  Â  }
Â  Â  Â  Â  initApp();
Â  Â  });
</script>
</body>
</html>